{{- if .Values.networkPolicy.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: validator-isolation
  namespace: {{ .Values.global.namespace.validators }}
  labels:
    {{- include "ethereum-validator.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      component: validator
  policyTypes: ["Ingress","Egress"]

  ingress:
    # Allow Prometheus scrape from monitoring namespace
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
          podSelector:
            matchLabels:
              app: prometheus
      ports:
        - { protocol: TCP, port: 5054 } # validator-consensus metrics
        - { protocol: TCP, port: 5064 } # validator-client metrics

    # Optional: allow in-namespace access to validator BN HTTP (debug)
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.global.namespace.validators | quote }}
      ports:
        - { protocol: TCP, port: 5052 } # validator-consensus HTTP

  egress:
    # DNS to CoreDNS in kube-system
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - { protocol: UDP, port: 53 }
        - { protocol: TCP, port: 53 }

    # Validator BN -> Execution Engine (via Service execution-lb)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.global.namespace.validators | quote }}
          podSelector:
            matchLabels:
              client: execution
      ports:
        - { protocol: TCP, port: 8551 }

    # Validator VC -> Sentry beacon nodes (both)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.global.namespace.validators | quote }}
          podSelector:
            matchLabels:
              component: sentry1
              client: consensus
      ports:
        - { protocol: TCP, port: 5052 }

    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.global.namespace.validators | quote }}
          podSelector:
            matchLabels:
              component: sentry2
              client: consensus
      ports:
        - { protocol: TCP, port: 5052 }
  {{- end }}